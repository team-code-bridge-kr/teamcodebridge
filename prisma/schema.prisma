generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 멘토(사용자) 모델
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  teamcodebridgeEmail String?   // teamcodebridge 메일
  emailVerified DateTime?
  image         String?
  role          String    @default("MENTOR")
  team          String?   // 소속팀
  position      String?   // 직책
  phone         String?   // 전화번호
  university    String?   // 학교
  joinDate      String?   // 입사일
  status        String?   // 재직여부
  isApproved    Boolean   @default(false) // 관리자 승인 여부
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  tasks         Task[]
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
}

// 프로젝트 모델
model Project {
  id          String   @id @default(cuid())
  title       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tasks       Task[]
}

// 업무(Task) 모델
model Task {
  id          String   @id @default(cuid())
  name        String
  status      String   @default("대기") // 대기, 진행 중, 완료, 지연
  priority    String   @default("중간") // 낮음, 중간, 높음
  timeline    String?
  driveUrl    String?
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
  ownerId     String?
  owner       User?    @relation(fields: [ownerId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  context     ContextCapsule?
}

// 채팅 메시지 모델
model Message {
  id        String   @id @default(cuid())
  content   String
  senderId  String
  sender    User     @relation("SentMessages", fields: [senderId], references: [id])
  receiverId String
  receiver  User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
}

// Context Switch Buffer (CSB) 모델
model ContextCapsule {
  id              String   @id @default(cuid())
  taskId          String   @unique
  task            Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  // Clear Phase (종료/전환 시 작업자가 기록)
  lastStableState String?  @db.Text
  openLoops       String?  @db.Text
  nextAction      String?  @db.Text
  
  // Ignition Phase (진입 시 확인)
  mission         String?  @db.Text // 업무 생성자가 정의 (초기 목표)
  risks           String?  @db.Text // 작업자가 추가 (예상 리스크)
  
  updatedAt       DateTime @updatedAt
}
