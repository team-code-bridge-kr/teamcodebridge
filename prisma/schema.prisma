generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 멘토(사용자) 모델
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  teamcodebridgeEmail String?   // teamcodebridge 메일
  emailVerified DateTime?
  image         String?
  role          String    @default("MENTOR")
  team          String?   // 소속팀
  position      String?   // 직책
  phone         String?   // 전화번호
  university    String?   // 학교
  joinDate      String?   // 입사일
  status        String?   // 재직여부
  isApproved    Boolean   @default(false) // 관리자 승인 여부
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  tasks         Task[]
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
  createdAnnouncements Announcement[] @relation("CreatedAnnouncements")
  createdEvents CalendarEvent[] @relation("CreatedEvents")
  pollVotes     PollVote[]
  createdPolls  MeetingPoll[] @relation("CreatedPolls")
  createdChatRooms ChatRoom[] @relation("CreatedChatRooms")
  chatRoomMembers ChatRoomMember[]
  createdCurriculums Curriculum[] @relation("CreatedCurriculums")
  uploadedMaterials Material[] @relation("UploadedMaterials")
  createdSurveys Survey[] @relation("CreatedSurveys")
}

// 프로젝트 모델
model Project {
  id          String   @id @default(cuid())
  title       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tasks       Task[]
}

// 업무 상태 열거형
enum TaskStatus {
  PENDING     // 대기
  IN_PROGRESS // 진행 중
  BLOCKED     // 차단됨
  COMPLETED   // 완료
  DEFERRED    // 지연
}

// 우선순위 열거형
enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// 링크 타입 열거형
enum LinkType {
  SPEC        // 기획서/명세서
  DESIGN      // 디자인 문서/Figma
  CODE        // 코드 참조
  DATA        // 데이터 소스/대시보드
  PARENT      // 상위 업무
  BLOCKER     // 차단 의존성
  RELATED     // 연관 참조
}

// 업무(Task) 모델
model Task {
  id          String     @id @default(cuid())
  name        String
  status      TaskStatus @default(PENDING)
  priority    Priority   @default(MEDIUM)
  timeline    String?
  driveUrl    String?
  projectId   String
  project     Project    @relation(fields: [projectId], references: [id])
  ownerId     String?
  owner       User?      @relation(fields: [ownerId], references: [id])
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  context     ContextCapsule?
  links       TaskLink[]
  
  // 크라켄 구조용 필드
  parentId    String?  // 상위 업무 ID (계층 구조)
  parent      Task?    @relation("TaskHierarchy", fields: [parentId], references: [id])
  children    Task[]   @relation("TaskHierarchy")
  
  depth       Int      @default(0)  // 0=Core, 1=Main Branch, 2+=Sub Branch
  
  dependsOnId String?  // 선행 업무 ID (의존성)
  dependsOn   Task?    @relation("TaskDependency", fields: [dependsOnId], references: [id])
  dependents  Task[]   @relation("TaskDependency")
}

// 업무 링크 모델 (외부 문서/아티팩트 연결)
model TaskLink {
  id          String   @id @default(cuid())
  taskId      String
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  // Link Type (REQUIRED)
  linkType    LinkType
  
  // Target (exactly one must be set)
  url         String?           // External URL (Notion, Confluence, etc.)
  repoPath    String?           // GitHub path (org/repo#issue or org/repo/path)
  artifactId  String?           // Internal artifact reference
  
  // Metadata
  label       String?           // Human-readable label
  isRequired  Boolean  @default(false)  // Must be opened before starting
  
  createdAt   DateTime @default(now())
  
  @@index([taskId])
}

// 채팅방 모델 (그룹 채팅)
model ChatRoom {
  id          String   @id @default(cuid())
  name        String   // 채팅방 이름
  description String?  // 채팅방 설명
  createdById String   // 생성자 ID
  createdBy   User     @relation("CreatedChatRooms", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  members     ChatRoomMember[]
  messages    Message[]
}

// 채팅방 멤버 모델
model ChatRoomMember {
  id         String   @id @default(cuid())
  chatRoomId String
  chatRoom   ChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  joinedAt   DateTime @default(now())
  
  @@unique([chatRoomId, userId]) // 한 사용자는 한 채팅방에 한 번만 참여 가능
  @@index([chatRoomId])
  @@index([userId])
}

// 채팅 메시지 모델
model Message {
  id         String    @id @default(cuid())
  content    String
  senderId   String
  sender     User      @relation("SentMessages", fields: [senderId], references: [id])
  receiverId String?   // 1:1 채팅용 (선택적)
  receiver   User?     @relation("ReceivedMessages", fields: [receiverId], references: [id])
  chatRoomId String?   // 그룹 채팅용 (선택적)
  chatRoom   ChatRoom? @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  read       Boolean   @default(false)
  createdAt  DateTime  @default(now())
  
  @@index([chatRoomId])
  @@index([senderId, receiverId])
}

// Context Switch Buffer (CSB) 모델
model ContextCapsule {
  id              String   @id @default(cuid())
  taskId          String   @unique
  task            Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  // Clear Phase (종료/전환 시 작업자가 기록)
  lastStableState String?  @db.Text
  openLoops       String?  @db.Text
  nextAction      String?  @db.Text
  
  // Ignition Phase (진입 시 확인)
  mission         String?  @db.Text // 업무 생성자가 정의 (초기 목표)
  risks           String?  @db.Text // 작업자가 추가 (예상 리스크)
  
  updatedAt       DateTime @updatedAt
}

// 공지사항 모델
model Announcement {
  id          String   @id @default(cuid())
  title       String
  content     String   @db.Text
  category    String   @default("공지") // 공지, 업데이트, 이벤트 등
  isImportant Boolean  @default(false)
  createdById String?
  createdBy   User?    @relation("CreatedAnnouncements", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// 캘린더 이벤트 모델
model CalendarEvent {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  startDate   DateTime
  endDate     DateTime?
  location    String?  // 장소
  type        String   @default("회의") // 회의, 일정, 이벤트 등
  color       String?  // 캘린더 색상
  createdById String?
  createdBy   User?    @relation("CreatedEvents", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// 회의 일정 투표 모델 (Lectumeet 스타일)
model MeetingPoll {
  id          String   @id @default(cuid())
  title       String   // 회의 제목
  description String?  @db.Text // 회의 안건
  voteDeadline DateTime? // 투표 마감일
  createdById String
  createdBy   User    @relation("CreatedPolls", fields: [createdById], references: [id])
  status      String   @default("진행중") // 진행중, 완료
  selectedOptionId String? // 최종 선택된 옵션 ID
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  options     PollOption[]
}

// 투표 옵션 (날짜/시간)
model PollOption {
  id          String   @id @default(cuid())
  pollId      String
  poll        MeetingPoll @relation(fields: [pollId], references: [id], onDelete: Cascade)
  startDate   DateTime
  endDate     DateTime?
  votes       PollVote[]
  createdAt   DateTime @default(now())
}

// 투표 결과 (누가 어떤 옵션에 투표했는지)
model PollVote {
  id          String   @id @default(cuid())
  pollId      String
  optionId    String
  option      PollOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  
  @@unique([optionId, userId]) // 한 사용자는 한 옵션에 한 번만 투표 가능 (하지만 여러 옵션에 투표 가능)
  @@index([pollId])
  @@index([userId])
}

// 커리큘럼 모델 (멘토링 프로그램)
model Curriculum {
  id                  String   @id @default(cuid())
  name                String   // 프로그램명
  description         String   @db.Text // 프로그램 소개 (200자 이내)
  motivation          String   @db.Text // 활동기획계기 (200자 이내)
  benefits            String   @db.Text // 활동을 통해 얻게 되는 점
  minMentors          Int      // 최소 현장 멘토 수
  recommendedStudents Int      // 추천 수혜 학생수
  expectedEffect      String   @db.Text // 기대효과
  status              String   @default("준비중") // 준비중, 검토중, 수업중, 종료됨
  createdById         String?
  createdBy           User?    @relation("CreatedCurriculums", fields: [createdById], references: [id])
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  sessions            CurriculumSession[] // 회차별 프로그램
  materials           Material[] // 교재
}

// 커리큘럼 회차 (4회차 기준)
model CurriculumSession {
  id              String     @id @default(cuid())
  curriculumId    String
  curriculum      Curriculum @relation(fields: [curriculumId], references: [id], onDelete: Cascade)
  sessionNumber   Int        // 회차 (1, 2, 3, 4)
  sessionName     String     // 세부 프로그램명
  scheduledDate   String?    // 일시
  location        String?    // 장소
  goal            String     @db.Text // 활동목표
  content         String     @db.Text // 활동내용
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  @@index([curriculumId])
}

// 교재 모델
model Material {
  id              String     @id @default(cuid())
  name            String     // 교재 이름
  description     String     @db.Text // 교재 설명
  fileType        String     // 파일 형식 (PDF, ZIP, PPT, DOCX, XLSX, MP4, etc.)
  driveUrl        String     // 구글 드라이브 링크
  fileSize        String?    // 파일 용량 (예: "2.5 MB")
  curriculumId    String
  curriculum      Curriculum @relation(fields: [curriculumId], references: [id], onDelete: Cascade)
  uploadedById    String?
  uploadedBy      User?      @relation("UploadedMaterials", fields: [uploadedById], references: [id])
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  @@index([curriculumId])
}

// 만족도 조사 (설문조사) 모델
model Survey {
  id              String           @id @default(cuid())
  title           String           // 설문조사명
  description     String?          @db.Text // 설문조사 설명
  targetClass     String?          // 대상 수업 (수업관리에서 롤업 또는 직접입력)
  startDate       DateTime?        // 설문 시작일
  endDate         DateTime?        // 설문 종료일
  googleFormId    String?          @unique // Google Forms ID (생성 후 저장)
  googleFormUrl   String?          // Google Forms URL
  googleSheetUrl  String?          // Google Sheets 응답 URL
  status          String           @default("준비중") // 준비중, 진행중, 종료
  responseCount   Int              @default(0) // 응답 수
  isDraft         Boolean          @default(true) // 임시저장 여부
  createdById     String?
  createdBy       User?            @relation("CreatedSurveys", fields: [createdById], references: [id])
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  questions       SurveyQuestion[] // 설문 질문들
  
  @@index([createdById])
  @@index([status])
}

// 설문 질문 모델
model SurveyQuestion {
  id              String   @id @default(cuid())
  surveyId        String
  survey          Survey   @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  order           Int      // 질문 순서
  questionText    String   @db.Text // 질문 내용
  questionType    String   // 질문 타입: TEXT, PARAGRAPH, MULTIPLE_CHOICE, CHECKBOX, LINEAR_SCALE, DATE, TIME, EMAIL, PHONE
  required        Boolean  @default(true) // 필수 여부
  options         Json?    // 객관식/체크박스 옵션 (JSON 배열)
  scaleMin        Int?     // 척도 최소값 (예: 1)
  scaleMax        Int?     // 척도 최대값 (예: 5)
  scaleMinLabel   String?  // 척도 최소 레이블 (예: "매우 불만족")
  scaleMaxLabel   String?  // 척도 최대 레이블 (예: "매우 만족")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([surveyId])
  @@index([order])
}
