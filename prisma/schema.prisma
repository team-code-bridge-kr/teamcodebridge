generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 멘토(사용자) 모델
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  teamcodebridgeEmail String?   // teamcodebridge 메일
  emailVerified DateTime?
  image         String?
  role          String    @default("MENTOR")
  team          String?   // 소속팀
  position      String?   // 직책
  phone         String?   // 전화번호
  university    String?   // 학교
  joinDate      String?   // 입사일
  status        String?   // 재직여부
  isApproved    Boolean   @default(false) // 관리자 승인 여부
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  tasks         Task[]
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
  createdAnnouncements Announcement[] @relation("CreatedAnnouncements")
  createdEvents CalendarEvent[] @relation("CreatedEvents")
  pollVotes     PollVote[]
  createdPolls  MeetingPoll[] @relation("CreatedPolls")
  createdChatRooms ChatRoom[] @relation("CreatedChatRooms")
  chatRoomMembers ChatRoomMember[]
}

// 프로젝트 모델
model Project {
  id          String   @id @default(cuid())
  title       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tasks       Task[]
}

// 업무(Task) 모델
model Task {
  id          String   @id @default(cuid())
  name        String
  status      String   @default("대기") // 대기, 진행 중, 완료, 지연
  priority    String   @default("중간") // 낮음, 중간, 높음
  timeline    String?
  driveUrl    String?
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
  ownerId     String?
  owner       User?    @relation(fields: [ownerId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  context     ContextCapsule?
}

// 채팅방 모델 (그룹 채팅)
model ChatRoom {
  id          String   @id @default(cuid())
  name        String   // 채팅방 이름
  description String?  // 채팅방 설명
  createdById String   // 생성자 ID
  createdBy   User     @relation("CreatedChatRooms", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  members     ChatRoomMember[]
  messages    Message[]
}

// 채팅방 멤버 모델
model ChatRoomMember {
  id         String   @id @default(cuid())
  chatRoomId String
  chatRoom   ChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  joinedAt   DateTime @default(now())
  
  @@unique([chatRoomId, userId]) // 한 사용자는 한 채팅방에 한 번만 참여 가능
  @@index([chatRoomId])
  @@index([userId])
}

// 채팅 메시지 모델
model Message {
  id         String    @id @default(cuid())
  content    String
  senderId   String
  sender     User      @relation("SentMessages", fields: [senderId], references: [id])
  receiverId String?   // 1:1 채팅용 (선택적)
  receiver   User?     @relation("ReceivedMessages", fields: [receiverId], references: [id])
  chatRoomId String?   // 그룹 채팅용 (선택적)
  chatRoom   ChatRoom? @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  read       Boolean   @default(false)
  createdAt  DateTime  @default(now())
  
  @@index([chatRoomId])
  @@index([senderId, receiverId])
}

// Context Switch Buffer (CSB) 모델
model ContextCapsule {
  id              String   @id @default(cuid())
  taskId          String   @unique
  task            Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  // Clear Phase (종료/전환 시 작업자가 기록)
  lastStableState String?  @db.Text
  openLoops       String?  @db.Text
  nextAction      String?  @db.Text
  
  // Ignition Phase (진입 시 확인)
  mission         String?  @db.Text // 업무 생성자가 정의 (초기 목표)
  risks           String?  @db.Text // 작업자가 추가 (예상 리스크)
  
  updatedAt       DateTime @updatedAt
}

// 공지사항 모델
model Announcement {
  id          String   @id @default(cuid())
  title       String
  content     String   @db.Text
  category    String   @default("공지") // 공지, 업데이트, 이벤트 등
  isImportant Boolean  @default(false)
  createdById String?
  createdBy   User?    @relation("CreatedAnnouncements", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// 캘린더 이벤트 모델
model CalendarEvent {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  startDate   DateTime
  endDate     DateTime?
  location    String?  // 장소
  type        String   @default("회의") // 회의, 일정, 이벤트 등
  color       String?  // 캘린더 색상
  createdById String?
  createdBy   User?    @relation("CreatedEvents", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// 회의 일정 투표 모델 (Lectumeet 스타일)
model MeetingPoll {
  id          String   @id @default(cuid())
  title       String   // 회의 제목
  description String?  @db.Text // 회의 안건
  voteDeadline DateTime? // 투표 마감일
  createdById String
  createdBy   User    @relation("CreatedPolls", fields: [createdById], references: [id])
  status      String   @default("진행중") // 진행중, 완료
  selectedOptionId String? // 최종 선택된 옵션 ID
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  options     PollOption[]
}

// 투표 옵션 (날짜/시간)
model PollOption {
  id          String   @id @default(cuid())
  pollId      String
  poll        MeetingPoll @relation(fields: [pollId], references: [id], onDelete: Cascade)
  startDate   DateTime
  endDate     DateTime?
  votes       PollVote[]
  createdAt   DateTime @default(now())
}

// 투표 결과 (누가 어떤 옵션에 투표했는지)
model PollVote {
  id          String   @id @default(cuid())
  pollId      String
  optionId    String
  option      PollOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  
  @@unique([optionId, userId]) // 한 사용자는 한 옵션에 한 번만 투표 가능 (하지만 여러 옵션에 투표 가능)
  @@index([pollId])
  @@index([userId])
}
