name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linter
        run: npm run lint || true
      
      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production
  
  deploy:
    name: Deploy Team Code Bridge
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            set -e
            echo "ğŸš€ GitHub Actions ë°°í¬ ì‹œì‘..."
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /root/teamcodebridge
            
            # Git ì¶©ëŒ ë°©ì§€ ë° ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            echo "ğŸ“¥ ìµœì‹  ì½”ë“œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤..."
            git fetch origin main
            git reset --hard origin/main
            
            # ì˜ì¡´ì„± í™•ì¸
            echo "ğŸ“¦ package-lock.json í™•ì¸ ì¤‘..."
            if [ ! -f "package-lock.json" ]; then
              echo "âš ï¸ package-lock.jsonì´ ì—†ìŠµë‹ˆë‹¤. npm installì„ ì‹¤í–‰í•©ë‹ˆë‹¤..."
              npm install
            fi
            
            # Docker ì •ë¦¬ (ë””ìŠ¤í¬ ê³µê°„ í™•ë³´)
            echo "ğŸ§¹ Docker ì •ë¦¬ ì¤‘..."
            docker system prune -f || true
            docker builder prune -f || true
            
            # Docker ë°°í¬
            echo "ğŸ³ Docker ë°°í¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤..."
            docker-compose down || true
            docker-compose build --no-cache
            
            # ë¹Œë“œ ë¡œê·¸ í™•ì¸
            echo "ğŸ“‹ ë¹Œë“œ ë¡œê·¸ í™•ì¸ ì¤‘..."
            docker-compose logs --tail=100 || true
            
            docker-compose up -d
            
            # ìƒíƒœ í™•ì¸
            echo "â³ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ì¤‘..."
            sleep 15
            
            # í—¬ìŠ¤ ì²´í¬
            echo "ğŸ¥ í—¬ìŠ¤ ì²´í¬ ì¤‘..."
            for i in {1..5}; do
              if docker ps | grep -q teamcodebridge-web; then
                echo "âœ… ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
                break
              fi
              echo "â³ ëŒ€ê¸° ì¤‘... ($i/5)"
              sleep 3
            done
            
            if docker ps | grep -q teamcodebridge-web; then
              echo "âœ… ë°°í¬ ì™„ë£Œ!"
              echo "ğŸŒ https://next.teamcodebridge.dev"
              docker ps | grep teamcodebridge-web
              
              # ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸
              echo "ğŸ“‹ ìµœê·¼ ë¡œê·¸:"
              docker-compose logs --tail=30 teamcodebridge-web || true
            else
              echo "âŒ ë°°í¬ ì‹¤íŒ¨"
              echo "ğŸ“‹ ì „ì²´ ë¡œê·¸:"
              docker-compose logs --tail=100
              exit 1
            fi