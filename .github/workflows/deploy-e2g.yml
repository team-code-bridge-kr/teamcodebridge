name: Deploy E2G Workspace (e2g.teamcodebridge.dev)

on:
  push:
    branches:
      - feat/mentor-workspace-next
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  build:
    name: Build and Test E2G
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: feat/mentor-workspace-next
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linter
        run: npm run lint || true
      
      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production
  
  deploy:
    name: Deploy E2G Workspace + Socket
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Deploy E2G via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            set -e
            echo "ğŸš€ E2G ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë°°í¬ ì‹œì‘ (e2g.teamcodebridge.dev)..."
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /root/teamcodebridge
            
            # feat/mentor-workspace-next ë¸Œëœì¹˜ë¡œ ì „í™˜
            echo "ğŸ“¥ feat/mentor-workspace-next ë¸Œëœì¹˜ë¡œ ì „í™˜..."
            git fetch origin feat/mentor-workspace-next
            git checkout feat/mentor-workspace-next
            git reset --hard origin/feat/mentor-workspace-next
            
            # .env íŒŒì¼ í™•ì¸
            echo "ğŸ“‹ .env íŒŒì¼ í™•ì¸ ì¤‘..."
            if [ ! -f ".env" ]; then
              echo "âš ï¸ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
            else
              echo "âœ… .env íŒŒì¼ì´ ì¡´ì¬í•©ë‹ˆë‹¤."
            fi
            
            # E2G ì„œë¹„ìŠ¤ë§Œ ì¤‘ì§€ (Webì€ ì˜í–¥ ì—†ìŒ)
            echo "ğŸ›‘ E2G ì„œë¹„ìŠ¤ë§Œ ì¤‘ì§€..."
            docker-compose -f docker-compose.e2g.yml down || true
            docker rm -f teamcodebridge-e2g-web teamcodebridge-socket 2>/dev/null || true
            
            # Docker ë¹Œë“œ
            echo "ğŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
            docker-compose -f docker-compose.e2g.yml build --no-cache
            
            # Docker ì‹¤í–‰
            echo "ğŸš€ E2G ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘..."
            docker-compose -f docker-compose.e2g.yml up -d
            
            # ìƒíƒœ í™•ì¸
            echo "â³ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ì¤‘..."
            sleep 15
            
            # í—¬ìŠ¤ ì²´í¬
            echo "ğŸ¥ í—¬ìŠ¤ ì²´í¬ ì¤‘..."
            for i in {1..10}; do
              if docker ps | grep -q teamcodebridge-e2g-web && docker ps | grep -q teamcodebridge-socket; then
                echo "âœ… E2G ì»¨í…Œì´ë„ˆë“¤ì´ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
                sleep 5
                if docker ps | grep -q teamcodebridge-e2g-web && docker ps | grep -q teamcodebridge-socket; then
                  echo "âœ… E2G ì„œë¹„ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
                  break
                fi
              fi
              echo "â³ ëŒ€ê¸° ì¤‘... ($i/10)"
              sleep 3
            done
            
            # ìµœì¢… ìƒíƒœ í™•ì¸
            echo "ğŸ“Š Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
            docker ps | grep -E "teamcodebridge-e2g-web|teamcodebridge-socket" || echo "âš ï¸ E2G ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            
            echo "ğŸ“Š Docker Compose ì„œë¹„ìŠ¤ ìƒíƒœ:"
            docker-compose -f docker-compose.e2g.yml ps || true
            
            if docker ps | grep -q teamcodebridge-e2g-web && docker ps | grep -q teamcodebridge-socket; then
              echo "âœ… E2G ë°°í¬ ì™„ë£Œ!"
              echo "ğŸŒ https://e2g.teamcodebridge.dev"
              docker ps | grep -E "teamcodebridge-e2g-web|teamcodebridge-socket"
              
              # ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸
              echo "ğŸ“‹ ìµœê·¼ ë¡œê·¸ (web):"
              docker-compose -f docker-compose.e2g.yml logs --tail=50 web || true
              echo "ğŸ“‹ ìµœê·¼ ë¡œê·¸ (socket):"
              docker-compose -f docker-compose.e2g.yml logs --tail=50 socket || true
            else
              echo "âŒ E2G ë°°í¬ ì‹¤íŒ¨"
              echo "ğŸ“‹ Docker Compose ë¡œê·¸:"
              docker-compose -f docker-compose.e2g.yml logs --tail=100 || true
              exit 1
            fi

