name: Deploy Web (next.teamcodebridge.dev)

on:
  push:
    branches:
      - main
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  build:
    name: Build and Test Web
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linter
        run: npm run lint || true
      
      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production
  
  deploy:
    name: Deploy Web Service
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Deploy Web via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            set -e
            echo "ğŸš€ Web ì„œë¹„ìŠ¤ ë°°í¬ ì‹œì‘ (next.teamcodebridge.dev)..."
            
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /root/teamcodebridge
            
            # main ë¸Œëœì¹˜ë¡œ ì „í™˜
            echo "ğŸ“¥ main ë¸Œëœì¹˜ë¡œ ì „í™˜..."
            git fetch origin main
            git checkout main
            git reset --hard origin/main
            
            # .env íŒŒì¼ í™•ì¸
            echo "ğŸ“‹ .env íŒŒì¼ í™•ì¸ ì¤‘..."
            if [ ! -f ".env" ]; then
              echo "âš ï¸ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
            else
              echo "âœ… .env íŒŒì¼ì´ ì¡´ì¬í•©ë‹ˆë‹¤."
            fi
            
            # Web ì„œë¹„ìŠ¤ë§Œ ì¤‘ì§€ (E2GëŠ” ì˜í–¥ ì—†ìŒ)
            echo "ğŸ›‘ Web ì„œë¹„ìŠ¤ë§Œ ì¤‘ì§€..."
            docker-compose -f docker-compose.web.yml down || true
            docker rm -f teamcodebridge-web 2>/dev/null || true
            
            # Docker ë¹Œë“œ
            echo "ğŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
            docker-compose -f docker-compose.web.yml build --no-cache
            
            # Docker ì‹¤í–‰
            echo "ğŸš€ Web ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘..."
            docker-compose -f docker-compose.web.yml up -d
            
            # ìƒíƒœ í™•ì¸
            echo "â³ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ì¤‘..."
            sleep 15
            
            # í—¬ìŠ¤ ì²´í¬
            echo "ğŸ¥ í—¬ìŠ¤ ì²´í¬ ì¤‘..."
            for i in {1..10}; do
              if docker ps | grep -q teamcodebridge-web; then
                echo "âœ… Web ì»¨í…Œì´ë„ˆê°€ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
                sleep 5
                if docker ps | grep -q teamcodebridge-web; then
                  echo "âœ… Web ì„œë¹„ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤."
                  break
                fi
              fi
              echo "â³ ëŒ€ê¸° ì¤‘... ($i/10)"
              sleep 3
            done
            
            # ìµœì¢… ìƒíƒœ í™•ì¸
            echo "ğŸ“Š Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
            docker ps | grep teamcodebridge-web || echo "âš ï¸ Web ì»¨í…Œì´ë„ˆë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            
            echo "ğŸ“Š Docker Compose ì„œë¹„ìŠ¤ ìƒíƒœ:"
            docker-compose -f docker-compose.web.yml ps || true
            
            if docker ps | grep -q teamcodebridge-web; then
              echo "âœ… Web ë°°í¬ ì™„ë£Œ!"
              echo "ğŸŒ https://next.teamcodebridge.dev"
              docker ps | grep teamcodebridge-web
              
              # ì»¨í…Œì´ë„ˆ ë¡œê·¸ í™•ì¸
              echo "ğŸ“‹ ìµœê·¼ ë¡œê·¸:"
              docker-compose -f docker-compose.web.yml logs --tail=50 web || true
            else
              echo "âŒ Web ë°°í¬ ì‹¤íŒ¨"
              echo "ğŸ“‹ Docker Compose ë¡œê·¸:"
              docker-compose -f docker-compose.web.yml logs --tail=100 || true
              exit 1
            fi

